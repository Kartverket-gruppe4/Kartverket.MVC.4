@model Kartverk.Mvc.Models.MapCorrectionModel

@{
ViewData["Title"] = "Meld inn en feil";
}

<h2>Meld inn en feil</h2>

<p>Bruk kartet nedenfor til å markere feilen du har oppdaget:</p>

<div id="map" style="height: 600px; margin-bottom: 10px;"></div>

<!-- "Neste" knapp for å åpne pop-up form -->
<input type="button" id="nesteKnapp" class="btn btn-success" value="Neste" onclick="openPopup()" style="margin-top:10px;" />

<!-- Pop-up feilmeldingsskjema -->
<div id="popupForm" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closePopup()">&times;</span>

        <h3>Feilmeldingsskjema</h3>

        <!-- Viser GeoJson Info -->
        <div class="form-group">
            <div class="form-group">
                <label>GeoJson:</label>
                <pre id="geoJsonInput"></pre>
            </div>
        </div>

        <!-- Nytt div-element for å vise kommuneinformasjon -->
        <div id="kommuneInfo" class="form-group" style="margin-top: 10px;">
            <!-- Kommuneinformasjon vil vises her etter henting -->
        </div> <!-- Avslutter kommuneInfo div -->

        <form asp-action="Save" method="post" enctype="multipart/form-data">
            @Html.ValidationSummary()
            @Html.HiddenFor(inputForm => inputForm.GeoJson, new { @id = "geoJsonHiddenInput" })
            @Html.HiddenFor(inputForm => inputForm.KommuneInfo, new { @id = "kommuneInfoHiddenInput" })
            
            <!-- Kategori -->
            <div class="form-group">
                <label asp-for="Category" class="form-label">Kategori</label>
                <select asp-for="Category" class="form-control" id="Category">
                    <option value="Tursti">Tursti</option>
                    <option value="Vei">Vei</option>
                    <option value="Sjø">Sjø</option>
                    <option value="Stedsnavn">Stedsnavn</option>
                    <option value="Annet">Annet/Vet ikke</option>
                </select>
            </div>

            <!-- Beskrivelse -->
            <div class="form-group">
                <label asp-for="Description" class="form-label">Beskrivelse</label>
                <input asp-for="Description" class="form-control" />
                <span asp-validation-for="Description" class="text-danger"></span>
            </div>

            <!-- Vedlegg -->
            <div class="form-group" style="margin-bottom: 10px;">
                <label asp-for="Attachment" class="form-label">Vedlegg</label>
                <input asp-for="Attachment" type="file" class="form-control" />
                <span asp-validation-for="Attachment" class="text-danger"></span>
            </div>

            <!-- Send-knapp -->
            <div class="form-group">
                <input type="submit" class="btn btn-success" value="Send" style="margin-top: 10px;" />
            </div>
        </form>
    </div>
</div> <!-- Avslutter popupForm div -->

@section Scripts {
    <script>
    // Opprett kartet
    var map = L.map('map').setView([58.164048, 8.004007], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Geoman for å tegne på kartet
    map.pm.addControls({
        position: 'topleft',
        drawCircleMarker: false,
        rotateMode: false,
        cutPolygon: false,
        drawText: false
    });

    function getLayerGeoJSON(layer) {
        const geojsonLayer = L.geoJSON(layer.toGeoJSON ? layer.toGeoJSON() : layer);
        return geojsonLayer.toGeoJSON();
    }

    function getFirstCoordinate(geoJson) {

        const { type, coordinates } = geoJson.features[0].geometry;
        var coordinatesArray;
        if (type === "Point") {
            coordinatesArray = coordinates;
        }
        if (type === "LineString") {
            coordinatesArray = coordinates[0];
        }
        if (type === "Polygon") {
            coordinatesArray = coordinates[0][0];
        }

        if(coordinatesArray.length > 0)
            return {
                longitude: coordinatesArray[0],
                latitude: coordinatesArray[1],
            };

        console.warn("Unsupported GeoJSON geometry type");
        return null;
    }

    // Funksjon for å hente koordinater og åpne pop-up skjemaet
    function openPopup() {
        var layers = L.PM.Utils.findLayers(map);
        if (layers.length <= 0)
            throw new Error("Must select layer.");

        var layer = layers[0]; // For nå, tar vi kun det første laget
        var geoJson = getLayerGeoJSON(layer);
        var coordinates = getFirstCoordinate(geoJson);

        if (!geoJson || !coordinates) {
            alert("GeoJSON data er ikke gyldig.");
            return;
        }

        var geoJsonString = JSON.stringify(geoJson);
        document.getElementById('geoJsonInput').textContent = geoJsonString;
        document.getElementById('geoJsonHiddenInput').value = geoJsonString;
           
        // Send AJAX-forespørsel til backend for å hente kommuneinformasjon
        fetch(`/api/feilmelding/kommuneinfo?nord=${coordinates.latitude}&ost=${coordinates.longitude}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error("Ingen kommuneinformasjon funnet for disse koordinatene.");
                }
                return response.json();
            })
            .then(data => {
                document.getElementById("kommuneInfoHiddenInput").value = JSON.stringify(data);
                document.getElementById("kommuneInfo").innerText =
                    `Kommune: ${data.kommunenavn}, Kommunenummer: ${data.kommunenummer}`;
            })
            .catch(error => {
                console.error("Feil ved henting av kommuneinformasjon:", error);
            });

        // Åpne modal pop-up og skjul "Neste" knappen
        document.getElementById("popupForm").style.display = "block";
        document.getElementById("nesteKnapp").style.display = "none";
    }

    // Funksjon for å lukke pop-up skjemaet
    function closePopup() {
        document.getElementById("popupForm").style.display = "none";
        document.getElementById("nesteKnapp").style.display = "inline-block";
    }

    // Lukk pop-up ved å klikke utenfor modal
    window.onclick = function (event) {
        var modal = document.getElementById("popupForm");
        if (event.target == modal) {
            closePopup();
        }
    }
</script>
}
